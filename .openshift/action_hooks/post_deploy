#!/bin/bash
# This deploy hook gets executed after dependencies are resolved and the
# build hook has been run but before the application has been started back
# up again.  This script gets executed directly, so it could be python, php,
# ruby, etc.

DRUPAL_SETTINGS=$OPENSHIFT_REPO_DIR/sites/default/settings.php

# check and set the symlink for vendor dir
if [ ! -d "$OPENSHIFT_REPO_DIR/sites/default/files" ]; then
    echo !!! files directory does NOT exist - creating symlink...
    #mkdir $OPENSHIFT_DATA_DIR/sites
    echo !!! created files directory - creating symlink...
    ln -s $OPENSHIFT_DATA_DIR/files $OPENSHIFT_REPO_DIR/sites/default/files
    echo !!! created symlink - setting permissions on directory...
    chmod -R 0755 $OPENSHIFT_DATA_DIR/files
    echo !!! permissions have been set on files directory!
else
    echo !!! sites directory already exists - skipping symlink...
fi

cat > $DRUPAL_SETTINGS << EOF
$databases = array (
  'default' => 
  array (
    'default' => 
    array (
      'database' => getenv('OPENSHIFT_APP_NAME'),
      'username' => getenv('OPENSHIFT_MYSQL_DB_USERNAME'),
      'password' => getenv('OPENSHIFT_MYSQL_DB_PASSWORD'),
      'host' => getenv('OPENSHIFT_MYSQL_DB_HOST'),
      'port' => getenv('OPENSHIFT_MYSQL_DB_PORT'),
      'driver' => 'mysql',
      'prefix' => '',
    ),
  ),
);
EOF

chmod u+w $DRUPAL_SETTINGS $OPENSHIFT_REPO_DIR/sites/default
