#!/bin/bash
# This deploy hook gets executed after dependencies are resolved and the
# build hook has been run but before the application has been started back
# up again.  This script gets executed directly, so it could be python, php,
# ruby, etc.

DRUPAL_SETTINGS=$OPENSHIFT_REPO_DIR/default/settings.php

# check and set the symlink for vendor dir
if [ ! -d "$OPENSHIFT_REPO_DIR/sites/default/files" ]; then
    echo !!! files directory does NOT exist - creating symlink...
    #mkdir $OPENSHIFT_DATA_DIR/sites
    echo !!! created files directory - creating symlink...
    ln -s $OPENSHIFT_DATA_DIR/files $OPENSHIFT_REPO_DIR/sites/default/files
    echo !!! created symlink - setting permissions on directory...
    chmod -R 0755 $OPENSHIFT_DATA_DIR/files
    echo !!! permissions have been set on files directory!
else
    echo !!! sites directory already exists - skipping symlink...
fi

touch $DRUPAL_SETTINGS

chmod u+w $DRUPAL_SETTINGS $OPENSHIFT_REPO_DIR/default
cat $DRUPAL_SETTINGS | ruby -e "puts STDIN.read.gsub(/\\\$databases\s*=\s*array.*?\)\;/m, '# Replaced by OpenShift')" > $OPENSHIFT_TMP_DIR/settings.php
cat << "END" >> $OPENSHIFT_TMP_DIR/settings.php


if [ ! -f "$OPENSHIFT_REPO_DIR/default/settings.php" ]; then
	$databases = array (
	  'default' => 
	  array (
		'default' => 
		array (
      		'database' => 'cityfruit',
     		 'username' => getenv('OPENSHIFT_MYSQL_DB_USERNAME'),
      		'password' => getenv('OPENSHIFT_MYSQL_DB_PASSWORD'),
      		'host' => getenv('OPENSHIFT_MYSQL_DB_HOST'),
      		'port' => getenv('OPENSHIFT_MYSQL_DB_PORT'),
		  'driver' => 'mysql',
		  'prefix' => '',
		),
	  ),
	);
END
  cat $OPENSHIFT_TMP_DIR/settings.php > $DRUPAL_SETTINGS
